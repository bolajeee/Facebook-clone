generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// USER MODEL
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  username  String   @unique
  firstName String
  lastName  String
  bio       String?
  avatar    String?  // Cloudinary URL
  isVerified Boolean @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Authentication fields
  password String
  refreshToken String?


  // Posts created by this user
  posts     Post[]
  
  // Comments made by this user
  comments  Comment[]
  
  // Likes given by this user
  likes     Like[]
  
  // Users this user is following
  following Follow[] @relation("UserFollowing")
  
  // Users following this user
  followers Follow[] @relation("UserFollowers")
  
  // Notifications sent to this user
  notifications Notification[]

  // INDEXES for performance
  @@index([email])
  @@index([username])
  @@index([createdAt])
  @@map("users")
}

// POST MODEL
model Post {
  id        String   @id @default(cuid())
  content   String
  imageUrl  String?  // Cloudinary URL for post images
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Foreign key to user who created the post
  authorId  String
  author    User     @relation(fields: [authorId], references: [id], onDelete: Cascade)

  // Comments on this post
  comments  Comment[]
  
  // Likes on this post
  likes     Like[]
  
  // Notifications generated by this post
  notifications Notification[]

  // INDEXES for feed performance
  @@index([authorId])            // Find posts by specific user
  @@index([createdAt])           // Order posts chronologically
  @@index([authorId, createdAt]) // Compound index for user's posts ordered by time
  @@map("posts")
}

// COMMENT MODEL
model Comment {
  id        String   @id @default(cuid())
  content   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Foreign key to the post being commented on
  postId    String
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)

  // Foreign key to user who made the comment
  authorId  String
  author    User     @relation(fields: [authorId], references: [id], onDelete: Cascade)

  // Notifications generated by this comment
  notifications Notification[]

  // INDEXES for performance
  @@index([postId])             // Find comments for a specific post
  @@index([authorId])           // Find comments by specific user
  @@index([postId, createdAt])  // Order comments on a post chronologically
  @@map("comments")
}

// LIKE MODEL
model Like {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  // Foreign key to the post being liked
  postId    String
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)

  // Foreign key to user who liked the post
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Notifications generated by this like
  notifications Notification[]

  // Ensure a user can only like a post once
  @@unique([postId, userId])
  
  // INDEXES for performance
  @@index([postId])             // Count likes for a post
  @@index([userId])             // Find posts liked by user
  @@index([postId, createdAt])  // Order likes on a post chronologically
  @@map("likes")
}

// FOLLOW MODEL
model Follow {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now())

  // User who is following
  followerId  String
  follower    User     @relation("UserFollowing", fields: [followerId], references: [id], onDelete: Cascade)

  // User being followed
  followingId String
  following   User     @relation("UserFollowers", fields: [followingId], references: [id], onDelete: Cascade)

  // Notifications generated by this follow
  notifications Notification[]

  // Ensure a user can only follow another user once
  @@unique([followerId, followingId])
  
  // INDEXES for social graph queries
  @@index([followerId])         // Find who a user is following
  @@index([followingId])        // Find who is following a user
  @@index([followerId, createdAt]) // Order follows chronologically
  @@map("follows")
}

// NOTIFICATION model
model Notification {
  id        String   @id @default(cuid())
  type      NotificationType
  message   String
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())

  // Foreign key to user receiving the notification
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Foreign keys for different notification types
  postId    String?
  post      Post?    @relation(fields: [postId], references: [id], onDelete: Cascade)

  commentId String?
  comment   Comment? @relation(fields: [commentId], references: [id], onDelete: Cascade)

  likeId    String?
  like      Like?    @relation(fields: [likeId], references: [id], onDelete: Cascade)

  followId  String?
  follow    Follow?  @relation(fields: [followId], references: [id], onDelete: Cascade)

  // INDEXES for notification queries
  @@index([userId])             // Find notifications for a user
  @@index([userId, isRead])     // Find unread notifications for a user
  @@index([userId, createdAt])  // Order notifications chronologically
  @@map("notifications")
}

// ENUM for notification types
enum NotificationType {
  LIKE
  COMMENT
  FOLLOW
  MENTION
}